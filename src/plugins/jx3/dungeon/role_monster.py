from jinja2 import Template

from src.const.path import ASSETS, build_path
from src.utils.analyze import sort_dict_list
from src.utils.generate import generate
from src.utils.network import Request
from src.templates import SimpleHTML, get_saohua
from src.config import Config
from ._template import template_role_monsters

skill_map = {'30535': '16446', '30599': '16381', '30665': '16356', '30592': '16354',
             '30593': '16355', '30594': '16352', '30595': '16353', '30781': '16377',
             '30782': '16378', '30785': '16374', '30566': '16365', '30131': '16367',
             '30536': '16357', '30136': '16382', '30787': '16376', '30603': '16342',
             '30604': '16339', '30670': '16338', '30569': '16337', '30142': '16379',
             '30676': '16341', '30687': '16340', '30765': '16343', '30750': '16380',
             '30573': '16336', '30945': '16394', '30947': '16395', '30747': '16351',
             '30741': '16349', '30631': '16392', '30635': '16393', '30606': '16447',
             '30582': '16347', '30583': '16346', '30587': '16345', '30137': '16344',
             '30608': '16358', '30609': '16391', '30610': '16397', '30611': '16398',
             '30614': '16389', '30822': '16387', '30804': '16371', '30792': '16388',
             '30793': '16390', '30643': '16373', '30644': '16369', '30655': '16372',
             '30673': '16361', '30618': '16359', '30619': '19431', '30620': '16406',
             '30621': '16402', '30626': '16370', '30679': '16364', '30542': '16360',
             '30543': '16368', '30766': '16375', '30815': '16385', '30810': '16384',
             '30807': '16399', '30755': '16405', '30627': '16400', '31641': '16363',
             '31652': '16362', '30809': '16396', '30550': '16366', '30580': '16401',
             '30642': '16404', '30692': '16449', '30693': '16451', '30696': '16450',
             '30698': '16448', '35129': '19433', '35130': '19435', '35131': '19436',
             '35132': '19455', '30700': '16443', '30702': '16442', '30701': '16441',
             '31801': '16386', '30714': '16445', '30705': '16444', '32049': '17690',
             '32050': '17689', '32051': '17687', '32052': '17686', '33602': '18507',
             '33601': '18506', '35133': '19454', '35134': '19457', '35135': '19452',
             '35136': '19450', '35137': '19456', '35138': '19434', '35139': '19449',
             '35140': '19458', '36712': '21404', '36713': '21405', '36714': '21406',
             '36715': '21408', '36716': '21407', '37672': '22600', '37673': '22601',
             '37674': '22602', '37675': '22603', '39291': '23694', '39292': '23683',
             '39293': '23693', '39294': '23690', '39295': '23672', '39296': '23669',
             '39297': '23684', '39298': '23679', '39299': '23689', '39300': '23687',
             '39301': '23688', '39302': '23678', '39204': '23674', '39215': '23695',
             '39303': '23666', '39304': '23667', '39254': '23691', '39305': '23686',
             '39306': '23676', '39307': '23661', '39308': '23677', '39309': '23682',
             '39310': '23692', '39311': '23662', '39258': '23668'}

async def get_role_monsters_map(server: str, role_name: str):
    role_monster_data = (await Request(f"{Config.jx3.api.url}/data/role/monster?server={server}&name={role_name}&token={Config.jx3.api.token}").get()).json()
    data = role_monster_data["data"]
    content = []
    skill_list = sort_dict_list(data["skillList"], "nLevel")[::-1]
    for skill in skill_list:
        new = Template(template_role_monsters).render(
            icon = build_path(ASSETS,["icon",f'{str(skill_map[str(skill["dwOutSkillID"])])}.png']),
            level = str(skill["nLevel"]),
            name = skill["szSkillName"]
        )
        content.append(new)
    html = str(
        SimpleHTML(
            "jx3",
            "role_monster.html",
            font = build_path(ASSETS, ["font", "PingFangSC-Medium.otf"]),
            table_content = "\n".join(content),
            gameEnergy = data["gameEnergy"],
            gameStamina = data["gameStamina"],
            server = data["serverName"],
            name = data["roleName"],
            msg = get_saohua()
        )
    )
    image = await generate(html, ".m-bmap.is-map-phone", segment=True)
    return image